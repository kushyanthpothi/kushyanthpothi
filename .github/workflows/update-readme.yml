# .github/workflows/update-readme.yml
name: üß† Update README with Repos

on:
  schedule:
    - cron: '0 0 * * *'     # Daily at midnight UTC
  workflow_dispatch:        # Manual trigger

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      # 1. Full clone so rebase will work
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Git config
      - name: Configure Git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 3. Sync remote ‚Üí local
      - name: Pull & rebase from main
        run: |
          git fetch origin main
          git rebase origin/main

      # 4. Fetch GitHub repos & build markdown
      - name: Generate repo list
        run: |
          curl -s "https://api.github.com/users/kushyanthpothi/repos?per_page=100" | \
            jq -r '
              .[] |
              [
                .name,
                .html_url,
                (.description // "No description"),
                .updated_at
              ] | @tsv
            ' > repos.tsv

          # Build Markdown with sub-bullets
          {
            echo "" 
            while IFS=$'\t' read -r name url desc updated; do
              fmt=$(date -d "$updated" +"%Y-%m-%d")
              safe=$(printf '%s' "$desc" \
                | sed 's/\\/\\\\/g; s/\[/\\[/g; s/\]/\\]/g; s/*/\\*/g')
              echo "- [$name]($url)"
              echo "  - Description: $safe"
              echo "  - Updated on: $fmt"
              echo ""
            done < repos.tsv
          } > repo_list.md

          # Inject into README
          awk '
            /<!--START_SECTION:repo_list-->/ {
              print
              while ((getline l < "repo_list.md") > 0) print l
              skip=1; next
            }
            /<!--END_SECTION:repo_list-->/ {skip=0}
            skip!=1
          ' README.md > tmp.md && mv tmp.md README.md

      # 5. Commit & push if anything changed
      - name: Commit & push
        run: |
          if git diff --quiet; then
            echo "‚úîÔ∏è README up to date‚Äîno changes."
          else
            git add README.md
            git commit -m "üîÑ Update repo list with description & updated date"
            git push origin HEAD:main
          fi
