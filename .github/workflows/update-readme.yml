name: 🧠 Update README with Repos

on:
  schedule:
    - cron: '0 0 * * *'     # Daily at midnight UTC
  workflow_dispatch:        # Manual trigger

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0       # ← ensures you can pull/rebase

      - name: Configure Git user
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync with remote main
        run: git pull --rebase origin main

      - name: Fetch repos & build markdown
        run: |
          curl -s "https://api.github.com/users/kushyanthpothi/repos?per_page=100" | \
            jq -r '
              .[] |
              [
                .name,
                .html_url,
                (.description // "No description"),
                .updated_at
              ] | @tsv
            ' > repos.tsv

          echo "" > repo_list.md
          while IFS=$'\t' read -r name url desc updated; do
            fmt_date=$(date -d "$updated" +"%Y-%m-%d")
            safe_desc=$(printf '%s' "$desc" \
              | sed 's/\\/\\\\/g; s/\[/\\[/g; s/\]/\\]/g; s/*/\\*/g')
            {
              echo "- [$name]($url)"
              echo "  - Description: $safe_desc"
              echo "  - Updated on: $fmt_date"
              echo ""
            }
          done < repos.tsv >> repo_list.md

          awk '
            /<!--START_SECTION:repo_list-->/ {
              print; 
              while ((getline line < "repo_list.md") > 0) print line;
              skip=1; next
            }
            /<!--END_SECTION:repo_list-->/ {skip=0}
            skip!=1
          ' README.md > temp.md && mv temp.md README.md

      - name: Commit & push if changed
        run: |
          if git diff --quiet; then
            echo "✔️ No changes to commit"
          else
            git add README.md
            git commit -m "🔄 Updated repo list with description & updated date"
            git push origin main
          fi
